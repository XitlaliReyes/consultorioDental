<div class="calendario-container">
  <h2>Gesti√≥n de Citas</h2>

  <!-- VISTA DE SELECCI√ìN INICIAL -->
  <div class="opcion-selection" *ngIf="currentView === 'selection'">
    <p class="subtitle">Selecciona la acci√≥n que deseas realizar:</p>
    <div class="opcion-cards">
      
      <div class="opcion-card" (click)="selectView('agendar')">
        <div class="opcion-icon"><h3>üìÖ Agendar Nueva Cita</h3></div>
        
        <p>Busca disponibilidad y reserva tu pr√≥xima consulta.</p>
      </div>
      
      <div class="opcion-card" (click)="selectView('mis-citas')">
        <div class="opcion-icon"><h3>üìã Mis Citas</h3></div>
        
        <p>Consulta tus citas agendadas y realiza cancelaciones.</p>
      </div>
      
    </div>
  </div>

  <!-- VISTA DE AGENDAR -->
  <div *ngIf="currentView === 'agendar'">
    <button type="button" class="btn-back" (click)="volverASeleccion()">‚Üê Volver a Selecci√≥n</button>
    
    <!-- BARRA DE PROGRESO ACTUALIZADA (3 PASOS) -->
    <div class="progress-bar">
      <span [class.active]="pasoActual >= 1">1. Servicio</span>
      <span [class.active]="pasoActual >= 2">2. M√©dico, Fecha y Hora</span>
      <span [class.active]="pasoActual >= 3">3. Confirmaci√≥n</span>
    </div>

    <!-- PASO 1: SELECCI√ìN DE SERVICIO -->
    <div class="paso-card" *ngIf="pasoActual === 1">
      <h3>Selecciona el Servicio que deseas agendar</h3>
      
      <div *ngIf="servicios.length === 0" class="loading-message">
        Cargando servicios o no hay servicios disponibles.
      </div>

      <div class="servicios-grid">
        <div 
          *ngFor="let servicio of servicios" 
          class="tarjeta-servicio"
          (click)="seleccionarServicio(servicio)"
        >
          <h4>{{ servicio.Nombre }}</h4>
          <p>{{ servicio.Descripcion }}</p>
          <div class="servicio-info">
            <span>üïí {{ servicio.Duracion }} min</span>
            <span class="costo">${{ servicio.Costo | number:'1.2-2' }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- PASO 2: SELECCI√ìN DE M√âDICO, FECHA Y HORA -->
    <div class="paso-card" *ngIf="pasoActual === 2">
      <div class="header-paso">
        <button class="btn-back" (click)="pasoActual = 1">‚Üê Volver</button>
        <h3>Servicio Seleccionado: <strong>{{ nombreServicioSeleccionado }}</strong></h3>
      </div>

      <!-- DROPDOWN DE SELECCI√ìN DE M√âDICO -->
      <div class="medico-selector">
        <label for="selectMedico">
          <span class="icon">üë®‚Äç‚öïÔ∏è</span> Selecciona el M√©dico:
        </label>
        <select 
          id="selectMedico" 
          [(ngModel)]="idMedicoSeleccionado" 
          (change)="onMedicoDropdownChange()"
          class="medico-dropdown"
        >
          <option [value]="null" disabled selected>-- Elige un m√©dico --</option>
          <option *ngFor="let medico of medicos" [value]="medico.ID_Medico">
            {{ getNombreCompletoMedico(medico) }}
          </option>
        </select>
      </div>

      <!-- MENSAJE SI NO SE HA SELECCIONADO M√âDICO -->
      <div *ngIf="!idMedicoSeleccionado" class="info-message">
        <p>üëÜ Por favor, selecciona un m√©dico para ver la disponibilidad de fechas y horarios.</p>
      </div>

      <!-- CALENDARIO Y HORARIOS (Solo visible si hay m√©dico seleccionado) -->
      <div *ngIf="idMedicoSeleccionado" class="seleccion-fecha-hora">
        
        <!-- CALENDARIO -->
        <div class="calendario-columna">
          <div class="calendario-header">
            <button type="button" class="nav-button" (click)="previousMonth()" [disabled]="!canNavigateToPrevious()">‚Üê</button>
            <h4 class="mes-a√±o">{{ getCurrentMonthYear() }}</h4>
            <button type="button" class="nav-button" (click)="nextMonth()" [disabled]="!canNavigateToNext()">‚Üí</button>
          </div>

          <div class="dias-semana">
            <div class="dia-semana" *ngFor="let dia of diasSemana">{{ dia }}</div>
          </div>

          <div class="dias-grid">
            <div 
              *ngFor="let dia of diasCalendario" 
              class="dia-celda"
              [class.dia-otro-mes]="!dia.esDelMesActual"
              [class.dia-seleccionado]="dia.estaSeleccionado"
              [class.dia-disponible]="dia.estaDisponible && dia.esDelMesActual"
              [class.dia-no-disponible]="!dia.estaDisponible || !dia.esDelMesActual"
              [class.dia-hoy]="dia.esHoy"
              (click)="seleccionarDia(dia)"
            >
              {{ dia.numero }}
            </div>
          </div>
        </div>

        <!-- HORAS -->
        <div class="horas-columna">
          <h4 *ngIf="!selectedDate">Selecciona un d√≠a en el calendario.</h4>
          <h4 *ngIf="selectedDate">Horas disponibles para {{ getFormattedSelectedDate() }}</h4>
          
          <div class="horas-grid">
            <button 
              *ngFor="let hora of horasDisponibles" 
              [class.selected]="hora === selectedHour"
              [class.disabled]="!isHoraDisponible(hora)"
              [disabled]="!isHoraDisponible(hora)"
              (click)="seleccionarHora(hora)"
              type="button"
            >
              {{ hora }}
            </button>
          </div>
          
          <button 
            *ngIf="selectedDate && selectedHour"
            (click)="pasoActual = 3" 
            class="btn-continuar"
            type="button"
          >
            Continuar ‚Üí
          </button>
        </div>
      </div>
    </div>

    <!-- PASO 3: CONFIRMACI√ìN -->
    <div class="paso-card" *ngIf="pasoActual === 3">
      <div class="header-paso">
        <button class="btn-back" (click)="pasoActual = 2">‚Üê Modificar</button>
        <h3>Confirma tu Cita</h3>
      </div>

      <div class="cita-resumen-final">
        <p class="resumen-item"><strong>Servicio:</strong> <span>{{ nombreServicioSeleccionado }}</span></p>
        <p class="resumen-item"><strong>M√©dico:</strong> <span>{{ nombreMedicoSeleccionado }}</span></p>
        <p class="resumen-item"><strong>Fecha:</strong> <span>{{ getFormattedSelectedDate() }}</span></p>
        <p class="resumen-item"><strong>Hora:</strong> <span>{{ selectedHour }}</span></p>
      </div>

      <div class="notas-container">
        <label for="notasCita">Notas o comentarios para el m√©dico (Opcional):</label>
        <textarea id="notasCita" [(ngModel)]="notasCita" rows="3" placeholder="Ej: Es mi primera visita."></textarea>
      </div>
      
      <button 
        (click)="confirmarCita()" 
        class="btn-confirmar-final"
        type="button"
      >
        Confirmar y Agendar
      </button>
    </div>
  </div>

  <!-- VISTA MIS CITAS -->
  <div *ngIf="currentView === 'mis-citas'">
    <button type="button" class="btn-back" (click)="volverASeleccion()">‚Üê Volver a Selecci√≥n</button>
    <app-mis-citas></app-mis-citas>
  </div>
</div>